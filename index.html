<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cumplea√±os - Katy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-image: url('https://images.pexels.com/photos/2263436/pexels-photo-2263436.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1');
            background-size: cover; background-position: center; background-attachment: fixed;
            font-family: 'Inter', sans-serif; overflow-x: hidden;
        }
        .font-pacifico { font-family: 'Pacifico', cursive; }
        .content-overlay {
            background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px);
            border-radius: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            animation: fadeInScale 0.8s ease-out forwards;
        }
        .modal { display: none; }
        .modal.flex { display: flex; }
        .photo-selected { border: 4px solid #a855f7; box-shadow: 0 0 15px rgba(168, 85, 247, 0.5); }
        .photo-selected .checkmark { display: block; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .animate-pulse-button { animation: pulse 2.5s infinite; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        .gallery-item-animation { animation: popIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes popUpMessage { 0% { opacity: 0; transform: scale(0.8) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .upload-success-animation { animation: popUpMessage 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; color: #16a34a; }
        .confetti { position: fixed; top: -10px; width: 10px; height: 10px; background-color: #f472b6; opacity: 0.7; border-radius: 50%; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); opacity: 0; } }
    </style>
</head>
<body class="text-gray-800">

    <div id="confetti-container"></div>

    <div class="min-h-screen w-full flex items-center justify-center p-4">
        <div class="content-overlay w-full max-w-md text-center p-6 sm:p-8">

            <div id="mainView">
                <header>
                    <div><img src="https://placehold.co/120x120/fecdd3/e11d48?text=ü•≥" alt="Icono de fiesta" class="rounded-full shadow-lg mx-auto mb-6 ring-4 ring-white"></div>
                    <h1 class="text-5xl sm:text-6xl font-pacifico text-pink-500 drop-shadow-lg">Mi cumplea√±os Katy</h1>
                    <p class="text-gray-600 mt-4 text-base sm:text-lg font-medium">¬°Compartamos los mejores momentos!</p>
                </header>
                
                <div class="grid grid-cols-2 gap-4 my-8 w-full max-w-sm mx-auto">
                    <input type="file" id="fileInput" multiple accept="image/*,video/*" class="hidden"/>
                    <label for="fileInput" class="h-full flex items-center justify-center cursor-pointer text-center bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-4 rounded-full shadow-lg transition-transform duration-300 animate-pulse-button">üì∏ Subir</label>
                    <button id="showGalleryBtn" class="h-full flex items-center justify-center text-center bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-300 animate-pulse-button" style="animation-delay: 0.2s;">üñºÔ∏è Ver Galer√≠a</button>
                    <button id="showVoteBtn" class="h-full flex items-center justify-center text-center bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-300 animate-pulse-button" style="animation-delay: 0.4s;">üòÇ Votar</button>
                    <button id="showRankingBtn" class="h-full flex items-center justify-center text-center bg-white border-2 border-pink-500 text-pink-500 hover:bg-pink-50 font-bold py-3 px-4 rounded-full shadow-lg transform hover:scale-105 transition-transform duration-300 animate-pulse-button" style="animation-delay: 0.6s;">üèÜ Ranking</button>
                </div>

                <div id="uploadProgressContainer" class="hidden mt-4 w-full max-w-sm mx-auto">
                    <p id="uploadStatus" class="mb-2 text-sm font-semibold">Subiendo tus recuerdos...</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="progressBar" class="bg-pink-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div></div>
                </div>
            </div>
            
            <section id="galleryViewSection" class="hidden">
                <h2 class="text-3xl font-pacifico text-pink-500 mb-6">Galer√≠a de Recuerdos</h2>
                <div id="galleryViewGrid" class="grid grid-cols-3 gap-3 max-h-[60vh] overflow-y-auto p-2"></div>
                <p id="galleryViewLoadingMessage" class="text-gray-500 mt-8">Cargando...</p>
                <button class="back-btn mt-6 text-pink-500 hover:underline font-semibold">‚Üê Volver</button>
            </section>

            <section id="voteSection" class="hidden">
                <h2 class="text-3xl font-pacifico text-pink-500 mb-2">Vot√° por tu favorita</h2>
                <p class="text-gray-600 mb-4 font-semibold">Selecciona exactamente 3 fotos</p>
                <div id="voteGrid" class="grid grid-cols-3 gap-3 max-h-[50vh] overflow-y-auto p-2"></div>
                <p id="voteLoadingMessage" class="text-gray-500 mt-8">Cargando...</p>
                <div class="mt-4">
                    <button id="confirmVoteBtn" class="w-full bg-gray-400 text-white font-bold py-3 px-4 rounded-full shadow-lg cursor-not-allowed transition-colors duration-300">Confirmar Votos (0/3)</button>
                    <button class="back-btn mt-4 text-pink-500 hover:underline font-semibold">‚Üê Volver</button>
                </div>
            </section>

            <section id="rankingSection" class="hidden">
                <h2 class="text-3xl font-pacifico text-pink-500 mb-6">Top 10 - M√°s Votadas</h2>
                <div id="rankingList" class="space-y-4 text-left max-h-[60vh] overflow-y-auto p-2"></div>
                <p id="rankingLoadingMessage" class="text-gray-500 mt-8">Cargando...</p>
                <button class="back-btn mt-6 text-pink-500 hover:underline font-semibold">‚Üê Volver</button>
            </section>
        </div>
    </div>
    
    <div id="thankYouModal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="text-center text-white p-8">
            <p class="text-5xl mb-4">üéâ</p>
            <h3 class="text-3xl font-bold font-pacifico">¬°Gracias por votar!</h3>
        </div>
    </div>

    <div id="imageModal" class="modal fixed inset-0 bg-black bg-opacity-80 items-center justify-center p-4 z-50">
        <div class="relative max-w-3xl max-h-full"><button id="closeModal" class="absolute -top-2 -right-2 text-white bg-pink-500 rounded-full h-8 w-8 flex items-center justify-center text-lg z-10">&times;</button><img id="modalImage" class="hidden max-w-full max-h-[80vh] rounded-lg" src=""><video id="modalVideo" class="hidden max-w-full max-h-[80vh] rounded-lg" src="" controls></video></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { getFirestore, doc, getDoc, setDoc, runTransaction, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
             apiKey: "AIzaSyBr3w4YCV6v-DmEA9JYRlZX-uop9HEHdtw",
  authDomain: "cumplekaty.firebaseapp.com",
  projectId: "cumplekaty",
  storageBucket: "cumplekaty.firebasestorage.app",
  messagingSenderId: "139981760540",
  appId: "1:139981760540:web:68fcb641edf1cdfb91d7d9"
        };

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const db = getFirestore(app);

        const mainView = document.getElementById('mainView');
        const galleryViewSection = document.getElementById('galleryViewSection');
        const voteSection = document.getElementById('voteSection');
        const rankingSection = document.getElementById('rankingSection');
        
        document.getElementById('showGalleryBtn').addEventListener('click', () => { mainView.classList.add('hidden'); galleryViewSection.classList.remove('hidden'); loadSimpleGallery(); });
        document.getElementById('showVoteBtn').addEventListener('click', () => { mainView.classList.add('hidden'); voteSection.classList.remove('hidden'); loadVoteOptions(); });
        document.getElementById('showRankingBtn').addEventListener('click', () => { mainView.classList.add('hidden'); rankingSection.classList.remove('hidden'); loadRanking(); });
        
        document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', () => {
            galleryViewSection.classList.add('hidden');
            voteSection.classList.add('hidden');
            rankingSection.classList.add('hidden');
            mainView.classList.remove('hidden');
        }));

        let userId = localStorage.getItem('userId');
        if (!userId) { userId = crypto.randomUUID(); localStorage.setItem('userId', userId); }
        let userData = { hasVoted: false };
        const userRef = doc(db, 'users', userId);
        
        async function initializeUser() {
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) { userData = userSnap.data(); } 
            else { await setDoc(userRef, userData); }
        }
        initializeUser();

        document.getElementById('fileInput').addEventListener('change', handleUpload);
        function handleUpload() {
            if (fileInput.files.length === 0) return;
            const files = fileInput.files;
            const uploadProgressContainer = document.getElementById('uploadProgressContainer');
            const progressBar = document.getElementById('progressBar');
            const uploadStatus = document.getElementById('uploadStatus');
            uploadProgressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            uploadStatus.textContent = `Subiendo tus recuerdos...`;

            let totalBytes = Array.from(files).reduce((acc, file) => acc + file.size, 0);
            let totalBytesTransferred = 0;

            const uploadPromises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const photoId = `${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, `media/${photoId}`);
                    const uploadTask = uploadBytesResumable(storageRef, file);
                    uploadTask.on('state_changed', 
                        (snapshot) => {}, 
                        reject, 
                        async () => {
                            const photoDocRef = doc(db, 'photos', photoId);
                            await setDoc(photoDocRef, { votes: 0, storagePath: storageRef.fullPath });
                            totalBytesTransferred += file.size;
                            progressBar.style.width = `${(totalBytesTransferred / totalBytes) * 100}%`;
                            resolve();
                        }
                    );
                });
            });

            Promise.all(uploadPromises).then(() => {
                uploadStatus.className = "mb-2 text-sm font-semibold upload-success-animation";
                uploadStatus.textContent = '¬°Archivos subidos con √©xito!';
                setTimeout(() => {
                    uploadProgressContainer.classList.add('hidden');
                    uploadStatus.className = "mb-2 text-sm font-semibold";
                }, 3000);
            }).catch(error => {
                console.error("Error al subir:", error);
                uploadStatus.innerHTML = `<span class="text-red-500">Ocurri√≥ un error.</span>`;
                setTimeout(() => uploadProgressContainer.classList.add('hidden'), 5000);
            });
            fileInput.value = '';
        }

        let selectedPhotos = [];
        const confirmVoteBtn = document.getElementById('confirmVoteBtn');
        confirmVoteBtn.addEventListener('click', handleConfirmVote);

        async function loadVoteOptions() {
            await initializeUser();
            if(userData.hasVoted) {
                document.getElementById('voteSection').innerHTML = `<h2 class="text-3xl font-pacifico text-pink-500 mb-2">¬°Ya votaste!</h2><p class="text-gray-600 mb-4">Gracias por participar.</p><button class="back-btn mt-6 text-pink-500 hover:underline font-semibold">‚Üê Volver</button>`;
                document.querySelector('#voteSection .back-btn').addEventListener('click', () => { voteSection.classList.add('hidden'); mainView.classList.remove('hidden'); });
                return;
            }
            selectedPhotos = [];
            updateVoteButton();
            const voteGrid = document.getElementById('voteGrid');
            const loadingMsg = document.getElementById('voteLoadingMessage');
            voteGrid.innerHTML = '';
            loadingMsg.textContent = 'Cargando fotos... ‚ú®';
            loadingMsg.classList.remove('hidden');
            const q = query(collection(db, "photos"));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) { loadingMsg.textContent = 'A√∫n no hay fotos para votar.'; return; }
            for (const photoDoc of querySnapshot.docs) {
                const photoData = photoDoc.data();
                const url = await getDownloadURL(ref(storage, photoData.storagePath));
                const container = document.createElement('div');
                container.className = 'relative cursor-pointer rounded-lg overflow-hidden';
                container.dataset.photoId = photoDoc.id;
                const isVideo = photoData.storagePath.match(/\.(mp4|mov|webm|ogg)$/i);
                const thumb = document.createElement(isVideo ? 'video' : 'img');
                thumb.src = url + (isVideo ? '#t=0.1' : '');
                thumb.className = "w-full h-28 object-cover transition-transform duration-300 transform group-hover:scale-110";
                const checkmark = document.createElement('div');
                checkmark.className = 'checkmark hidden absolute top-2 right-2 bg-purple-500 text-white rounded-full h-6 w-6 flex items-center justify-center';
                checkmark.innerHTML = '‚úî';
                container.appendChild(thumb);
                container.appendChild(checkmark);
                container.onclick = () => toggleVoteSelection(container, photoDoc.id);
                voteGrid.appendChild(container);
            }
            loadingMsg.classList.add('hidden');
        }

        function toggleVoteSelection(container, photoId) {
            const index = selectedPhotos.indexOf(photoId);
            if (index > -1) {
                selectedPhotos.splice(index, 1);
                container.classList.remove('photo-selected');
            } else {
                if(selectedPhotos.length < 3) {
                    selectedPhotos.push(photoId);
                    container.classList.add('photo-selected');
                }
            }
            updateVoteButton();
        }

        function updateVoteButton() {
            const votesToCast = selectedPhotos.length;
            confirmVoteBtn.textContent = `Confirmar Votos (${votesToCast}/3)`;
            if (votesToCast === 3) {
                confirmVoteBtn.disabled = false;
                confirmVoteBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                confirmVoteBtn.classList.add('bg-green-500');
            } else {
                confirmVoteBtn.disabled = true;
                confirmVoteBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                confirmVoteBtn.classList.remove('bg-green-500');
            }
        }

        async function handleConfirmVote() {
            if(selectedPhotos.length !== 3) return;
            confirmVoteBtn.disabled = true;
            confirmVoteBtn.textContent = 'Procesando...';
            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists() || userDoc.data().hasVoted) throw new Error("El usuario ya ha votado.");
                    let newTotalVotes = 0;
                    const statsRef = doc(db, "stats", "tally");
                    const statsDoc = await transaction.get(statsRef);
                    newTotalVotes = (statsDoc.exists() ? statsDoc.data().totalVotes : 0) + 3;
                    for(const photoId of selectedPhotos) {
                        const photoRef = doc(db, "photos", photoId);
                        const photoDoc = await transaction.get(photoRef);
                        if (!photoDoc.exists()) throw new Error(`La foto ${photoId} no existe.`);
                        transaction.update(photoRef, { votes: photoDoc.data().votes + 1 });
                    }
                    transaction.update(userRef, { hasVoted: true });
                    transaction.set(statsRef, { totalVotes: newTotalVotes }, { merge: true });
                });
                document.getElementById('thankYouModal').classList.add('flex');
                setTimeout(() => {
                    document.getElementById('thankYouModal').classList.remove('flex');
                    voteSection.classList.add('hidden');
                    mainView.classList.remove('hidden');
                }, 2500);
            } catch (e) {
                console.error("Transacci√≥n de voto fallida: ", e);
                confirmVoteBtn.textContent = 'Error al votar. Intenta de nuevo.';
                confirmVoteBtn.classList.remove('bg-green-500');
                confirmVoteBtn.classList.add('bg-red-500', 'cursor-not-allowed');
                setTimeout(() => {
                    confirmVoteBtn.disabled = false;
                    updateVoteButton();
                }, 4000);
            }
        }
        
        async function loadSimpleGallery() {
            const grid = document.getElementById('galleryViewGrid');
            const loadingMsg = document.getElementById('galleryViewLoadingMessage');
            grid.innerHTML = '';
            loadingMsg.textContent = 'Cargando recuerdos... ‚ú®';
            loadingMsg.classList.remove('hidden');
            const q = query(collection(db, "photos"), orderBy("storagePath", "desc"));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) { loadingMsg.textContent = 'A√∫n no hay fotos.'; return; }
            for (const [index, photoDoc] of querySnapshot.docs.entries()) {
                const photoData = photoDoc.data();
                const url = await getDownloadURL(ref(storage, photoData.storagePath));
                const isVideo = photoData.storagePath.match(/\.(mp4|mov|webm|ogg)$/i);
                const thumb = document.createElement(isVideo ? 'video' : 'img');
                thumb.src = url + (isVideo ? '#t=0.1' : '');
                thumb.className = "w-full h-28 object-cover rounded-lg cursor-pointer shadow-md gallery-item-animation";
                thumb.style.animationDelay = `${index * 0.05}s`;
                thumb.onclick = () => openModal(url, isVideo);
                grid.appendChild(thumb);
            }
            loadingMsg.classList.add('hidden');
        }
        async function loadRanking() {
            const rankingList = document.getElementById('rankingList');
            const loadingMsg = document.getElementById('rankingLoadingMessage');
            rankingList.innerHTML = '';
            loadingMsg.textContent = 'Calculando ranking... üìä';
            loadingMsg.classList.remove('hidden');
            const statsRef = doc(db, "stats", "tally");
            const statsSnap = await getDoc(statsRef);
            const totalVotes = statsSnap.exists() ? statsSnap.data().totalVotes : 1;
            const q = query(collection(db, "photos"), orderBy("votes", "desc"), limit(10));
            const querySnapshot = await getDocs(q);
            if (querySnapshot.empty) { loadingMsg.textContent = 'Nadie ha votado todav√≠a.'; return; }
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            for (const [index, photoDoc] of querySnapshot.docs.entries()) {
                const photoData = photoDoc.data();
                if (photoData.votes === 0) continue;
                const url = await getDownloadURL(ref(storage, photoData.storagePath));
                const percentage = totalVotes > 0 ? ((photoData.votes / totalVotes) * 100).toFixed(1) : 0;
                const item = document.createElement('div');
                item.className = 'flex items-center gap-4 p-2 rounded-lg bg-white bg-opacity-50';
                const medal = index < 3 ? medals[index] : `<span class="font-bold w-6 text-center">${index + 1}</span>`;
                item.innerHTML = `<div class="text-2xl w-8 text-center">${medal}</div><img src="${url}" class="w-16 h-16 object-cover rounded-md shadow-md"><div class="flex-grow"><div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-pink-400 h-4 rounded-full text-xs font-medium text-white text-center leading-none" style="width: ${percentage}%">${percentage}%</div></div></div>`;
                rankingList.appendChild(item);
            }
            loadingMsg.classList.add('hidden');
        }
        const imageModal = document.getElementById('imageModal');
        const closeModal = document.getElementById('closeModal');
        const modalImage = document.getElementById('modalImage');
        const modalVideo = document.getElementById('modalVideo');
        closeModal.addEventListener('click', () => { imageModal.classList.remove('flex'); modalVideo.pause(); });
        function openModal(url, isVideo) {
            if(isVideo) { modalVideo.src = url; modalVideo.classList.remove('hidden'); modalImage.classList.add('hidden'); modalVideo.play(); } 
            else { modalImage.src = url; modalImage.classList.remove('hidden'); modalVideo.classList.add('hidden'); }
            imageModal.classList.add('flex');
        }
        const confettiContainer = document.getElementById('confetti-container');
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = `${Math.random() * 100}vw`;
            confetti.style.animationDuration = `${Math.random() * 3 + 4}s`;
            confetti.style.animationDelay = `${Math.random() * 5}s`;
            confetti.style.backgroundColor = ['#ec4899', '#f9a8d4', '#fef3c7', '#a78bfa'][Math.floor(Math.random() * 4)];
            confettiContainer.appendChild(confetti);
        }
    </script>
</body>
</html>
